# Copilot Instructions for Chiri Blog Theme

## Project Overview
This is "Chiri" - a minimal Astro-based blog theme featuring content-driven architecture with MDX support, customizable theming, and embedded media capabilities. The project is deployed on Netlify and uses PNPM as the package manager.

## Architecture & Key Patterns

### Configuration-Driven Design
- **Central config**: [src/config.ts](src/config.ts) contains all theme settings via `themeConfig` object
- **Type-safe configuration**: All config options defined in [src/types/config.types.ts](src/types/config.types.ts) with strict TypeScript interfaces
- Changes to theme behavior should always go through config, not hardcoded values

### Content Architecture
- **Content collections**: Defined in [src/content.config.ts](src/content.config.ts) with Astro's new content loader API
- **Posts**: Located in `src/content/posts/` with frontmatter schema validation
- **About pages**: Separate collection in `src/content/about/`
- **Draft workflow**: Prefix filenames with `_` for drafts (handled in content processing)

### Custom Plugin System
The project heavily extends markdown processing with custom remark/rehype plugins:
- **Embedded media**: [src/plugins/remark-embedded-media.mjs](src/plugins/remark-embedded-media.mjs) - Converts custom directives (::link, ::spotify, ::youtube, ::github) to HTML
- **Reading time**: [src/plugins/remark-reading-time.mjs](src/plugins/remark-reading-time.mjs) - Injects reading time into frontmatter
- **TOC generation**: [src/plugins/remark-toc.mjs](src/plugins/remark-toc.mjs) - Table of contents from headings
- **Image processing**: [src/plugins/rehype-image-processor.mjs](src/plugins/rehype-image-processor.mjs) - Handles image optimization
- **Copy code**: [src/plugins/rehype-copy-code.mjs](src/plugins/rehype-copy-code.mjs) - Adds copy buttons to code blocks

## Development Workflow

### Post Creation
- **New posts**: Use `pnpm new "Post Title"` (creates properly formatted markdown file)
- **Draft posts**: Use `pnpm new "_Draft Title"` (underscore prefix for drafts)
- **Manual creation**: Posts go in `src/content/posts/` with required frontmatter: `title`, `pubDate`

### Build & Deployment
- **Development**: `pnpm dev` (Astro dev server)
- **Build process**: `pnpm build` runs `prebuild` script to toggle proxy settings
- **Deployment**: Configured for Netlify in [astro.config.ts](astro.config.ts) with `netlify()` adapter
- **Adapter switching**: Change adapter in astro.config.ts for different deployment targets (Vercel, static, etc.)

### Asset Pipeline
- **Images**: Use Astro's Sharp service with custom config in [src/utils/image-config.ts](src/utils/image-config.ts)
- **Fonts**: Self-hosted in `public/fonts/` with CSS definitions in [src/styles/fonts.css](src/styles/fonts.css)
- **KaTeX**: Math rendering with external CSS in `public/katex.min.css`

## Component Architecture

### Layout Hierarchy
```
BaseLayout.astro (site shell)
├── IndexLayout.astro (homepage)
└── PostLayout.astro (individual posts)
```

### Critical Components
- **Theme management**: [src/components/ui/ThemeManager.astro](src/components/ui/ThemeManager.astro) handles light/dark mode
- **Link cards**: [src/components/ui/LinkCard.astro](src/components/ui/LinkCard.astro) with client-side metadata fetching
- **Table of contents**: [src/components/ui/TableOfContents.astro](src/components/ui/TableOfContents.astro) with responsive behavior

### Styling Approach
- **CSS custom properties**: Theme system using CSS variables defined in components
- **No CSS framework**: Pure CSS with component-scoped styles
- **Responsive design**: Mobile-first approach with configurable content width

## Integration Points

### External Services
- **Link previews**: Client-side fetching via `/api/proxy.ts` API route
- **RSS feeds**: Generated at `/rss.xml` and `/atom.xml` using custom feed utilities
- **Open Graph**: Dynamic OG image generation in `src/pages/open-graph/[...route].ts`
- **Sitemap**: Auto-generated by Astro sitemap integration

### Deployment Dependencies
- **Netlify**: Primary deployment target with configuration in [netlify.toml](netlify.toml)
- **Link cards**: Require server adapter (not static) for metadata proxy API
- **Image optimization**: Relies on Sharp for build-time image processing

## Project-Specific Conventions
- **File organization**: Components grouped by purpose (`layout/`, `ui/`, `widgets/`)
- **Import aliases**: Use `@/` prefix for `src/` directory imports
- **Draft handling**: Files prefixed with `_` are treated as drafts throughout the system
- **Date formatting**: Configurable via `themeConfig.date` with multiple format options
- **Content width**: All layouts respect `themeConfig.general.contentWidth` setting

When adding features, maintain the configuration-driven approach and ensure new functionality integrates with the existing plugin system.