---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import BackButton from '@/components/ui/BackButton.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import ImageOptimizer from '@/components/ui/ImageOptimizer.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import GitHubCard from '@/components/ui/GitHubCard.astro'
import LinkCard from '@/components/ui/LinkCard.astro'
import NeoDBCard from '@/components/ui/NeoDBCard.astro'
import XPOST from '@/components/ui/XPOST.astro'
import CopyCode from '@/components/ui/CopyCode.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

import { themeConfig } from '@/config'

const { title, pubDate, readingTime, toc } = Astro.props as PostLayoutProps

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const ogImage = `/open-graph/${postSlug}.png`

// Check if this is a Genuary page - disable view transitions for these
const isGenuary = Astro.url.pathname.includes('/creative-code/genuary-2026/')
---

<BaseLayout
  title={`${title} · ${themeConfig.site.title}`}
  description={themeConfig.site.description}
  type="post"
>
  <BaseHead
    title={`${title} · ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container" transition:animate={isGenuary ? "none" : undefined}>
    <main>
      <div class="prose">
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        <div class="title">
          <h1>{title}</h1>
          <div class="date">
            <FormattedDate date={pubDate} context="post" />
            {
              themeConfig.post.readingTime && readingTime && (
                <span class="reading-time">
                  <span class="separator">·</span>
                  {readingTime.text}
                </span>
              )
            }
          </div>
        </div>
        <slot />
      </div>
    </main>
    <ImageOptimizer />
    <FootnoteScroll />
    <CopyCode />
    <GitHubCard />
    <XPOST />
    <NeoDBCard />
    {themeConfig.post.imageViewer && <ImageViewer />}
    {themeConfig.post.linkCard && <LinkCard />}
    {themeConfig.general.footer && <Footer />}
  </div>
</BaseLayout>

<script is:inline>
  // Clean up old sketch scripts before new content loads to prevent variable conflicts
  ;(() => {
    function cleanupOldSketches() {
      if (!window.location.pathname.includes('/creative-code/genuary-2026/')) return

      console.log('[Genuary] Cleaning up old sketches')
      
      // Remove old p5 sketch scripts and variables
      document.querySelectorAll('script[src^="/genuary-2026/"], script[src^="/p5"]').forEach((script) => {
        console.log('[Genuary] Removing old script:', script.src)
        script.remove()
      })

      // Clear sketch-related global variables that might persist
      const keysToDelete = Object.keys(window).filter(
        (key) => key.match(/^(sketch|img|canvas|p5|WIDTH|HEIGHT|CELL_SIZE)/) || 
                 typeof window[key] === 'object' && window[key]?.canvas
      )
      
      keysToDelete.forEach((key) => {
        try {
          delete window[key]
        } catch (e) {
          // Some window properties can't be deleted, that's ok
        }
      })

      // Remove p5 instance if it exists
      if (window.p5 && window.p5.Renderer && window.p5.Renderer.prototype) {
        const canvases = document.querySelectorAll('canvas')
        canvases.forEach((canvas) => {
          canvas.remove?.()
        })
      }
    }

    document.addEventListener('astro:before-swap', cleanupOldSketches)
  })()
</script>

<script is:inline>
  // Genuary pages have transitions disabled, so just clear globals on load
  if (window.location.pathname.includes('/creative-code/genuary-2026/')) {
    const varsToDelete = [
      'WIDTH', 'HEIGHT', 'CELL_SIZE', 'CELL_SIZE_2', 'DOT_HSL',
      'img', 'imgBuffer', 'shapeType', 'shapeSizeMultiplier',
      'setup', 'draw', 'keyPressed', 'mousePressed', 'preload',
      'p5', 'sketch'
    ]
    
    varsToDelete.forEach((varName) => {
      try {
        delete window[varName]
      } catch (e) {
        // Ignore errors for undeletable properties
      }
    })

    console.log('[Genuary] Cleared old global variables on page load')
  }
</script>

<style>
  .post-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-container main {
    flex: 1;
  }
</style>